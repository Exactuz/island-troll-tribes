
library FriendlyIdCreate requires ChatCommands, Map, GameConfig {

  struct data {
    real x;
    real y;
    real t;
    integer u;
    integer id;
    integer pid;
    integer next;
  }

  function DisplayHelp() {
    BJDebugMsg( GENERAL_COLOR + "=== Friendly ID Create!! ===" );
    BJDebugMsg( " " );
    BJDebugMsg( " " );
    BJDebugMsg( GENERAL_COLOR + "Syntax:" );
    BJDebugMsg( " " );
    BJDebugMsg( GENERAL_COLOR + "-create UNIT_MAMMOTH [player id [x y]]" );
    BJDebugMsg( GENERAL_COLOR + "default x, y => next to your hero" );
    BJDebugMsg( GENERAL_COLOR + "default player => you" );
    BJDebugMsg( " " );
    BJDebugMsg( GENERAL_COLOR + "-create ITEM_BATTLE_GLOVES [x y]" );
    BJDebugMsg( GENERAL_COLOR + "default x, y => next to your hero" );
  }

  function FriendlyIdSpawn(ArgsList a) {
    data d;
    unit u;

    if ( a[0] == "" ) {
      DisplayHelp();
      return;
    }

    // we have an ID, and we are spawning only 1 thing

    if ( S2ID( StringCase( a[0], true ) ) == 0 ) {
      BJDebugMsg( RED_COLOR + "ID " + a[0] + " Not Found!" );
      return;
    }

    // we have a valid id

    d     = data.create();
    d.id  = S2ID( StringCase( a[0], true ) );

    if ( a[1] != "" )
      d.pid = S2I( a[1] );
    else
      d.pid = GetPlayerId( a.triggerPlayer );

    if ( a[2] == "" ) {
      // u = FirstOfGroup( GetUnitsSelectedAll( a.triggerPlayer ) );
      // if ( u == null ) {
        u = GetPlayerTroll( a.triggerPlayer );
      // }

      d.x   = GetUnitX( u ) + 100 * Cos( Deg2Rad( GetUnitFacing( u )));
      d.y   = GetUnitY( u ) + 100 * Sin( Deg2Rad( GetUnitFacing( u )));
      d.pid = GetPlayerId( a.triggerPlayer );
      u     = null;
    }
    else {
      d.x   = S2R( a[2] );
      d.y   = S2R( a[3] );
    }

    // we have the data

    if ( SubString( StringCase( a[0], true ), 0, 4 ) == "UNIT" ) {
      CreateUnit( Player( d.pid ), d.id, d.x, d.y, 270 );
    }
    else if ( SubString( StringCase( a[0], true ), 0, 4 ) == "ITEM" ) {
      CreateItem( d.id, d.x, d.y );
    }
    else {
      BJDebugMsg( RED_COLOR + "Only UNIT and ITEM are supported right now" );
      DisplayHelp();
    }

    debug BJDebugMsg( HIGHLIGHT_COLOR + "Creating " + SubString( a[0], 5, 99) + "|r" );
  }

  function onInit() {
    Map.onGameStart(function() {
      if (GameConfig.getInstance().getTestMode()) {
        ChatCommands.registerArgFunc(null, "create", FriendlyIdSpawn);
      }
    });
  }
}
