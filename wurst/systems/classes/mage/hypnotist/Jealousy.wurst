package Jealousy
import RegisterEvents
import Orders
import Table
import ClosureTimers
import ClosureForGroups

@configurable constant int ABILITY_ID = 'A051'
<<<<<<< 673f03666a8266328b3065e23a5938b78e48aef8
@configurable constant int BUFF_ID = 'BHav'
=======
>>>>>>> Fix jealousy interval
@configurable constant real INTERVAL = 0.5
@configurable constant real CURSE_RADIUS = 600
@configurable constant real CURSE_DURATION = 7

constant targetTable = new Table()

function onCast()
    var target = GetSpellTargetUnit()
    var owner = target.getOwner()

    doPeriodicallyTimed(INTERVAL, CURSE_DURATION) cb ->
        if not target.isAlive() or not target.hasAbility(BUFF_ID)
            cb.stop()
        else
            forUnitsInRange(target.getPos(), CURSE_RADIUS) u ->
                if u != target and u.isAlive() and u.getOwner().isAllyOf(owner)
                    if not target.isInvulnerable() and not u.isInvulnerable()
                        u.issueTargetOrderById(Orders.attack, target)
<<<<<<< 673f03666a8266328b3065e23a5938b78e48aef8
=======

function onAnyOrder()
    var u = GetTriggerUnit()
    var index = u.getHandleId()

    if targetTable.hasHandle(index)
        var target = targetTable.loadUnit(index)
        if target.isAlive()
            let t = getPlayerUnitEventTrigger(EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
            t.disable()
            if target.isInvulnerable() or u.isInvulnerable()
                //u.issuePointOrderById(Oders.move, target.getPos())
                //Move to target location or something, the above code crashes game
            else
                u.issueTargetOrderById(Orders.attack, target)
            t.enable()
>>>>>>> Fix jealousy interval

init
    registerSpellEffectEvent(ABILITY_ID, () -> onCast())
